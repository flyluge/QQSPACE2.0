<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>相册</title>
		<script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
	</head>
	<script type="text/javascript">
		$(function() {
			$("#head").load("container/head.html");
			getSessionUser();
			/*异步查找用户相册 */
			
			/* 提交表单事件 */
			$("#uploadAlbum_sub").click(uploadFile);
		})
		/* 加载相册界面 */
		function getAlbumMess(){
			$.ajax({
				url:"AlbumAction_findAlbumByPage",
				type:"POST",
				dataType: "json",
				data:{"currpage":1,"pagesize":15,"uid":$("#sessionuser_uid").val()},
				success:function(data){
					$.each(data.data.page,function(i,n) {
						let a = `
								<div class="col-xs-4 col-md-2 .col-sm-3" style="padding: 5px;">
									<div class="thumbnail"  style="padding: 10px;height:180px;border:solid 1px gray;">
										<img src="${n.image}" class="img-responsive" alt="图片加载失败">
										<div class="caption" style="position:absolute;bottom:10%">
											<div class="text-right">
												${n.pubdate}
												<a onclick="deleteAl(${n.alid})" role="button">
													<span class="glyphicon glyphicon-trash"></span>
												</a>
											</div>
										</div>
									</div>
								</div>
						      `;
						$("#album_container").append(a);
					});
				}
			})
		}
		/* 删除相册 */
		function deleteAl(alid){
			$.ajax({
				url:"AlbumAction_deleteAlbum",
				type:"POST",
				dataType: "json",
				data:{"alid":alid},
				async: false, 
				success:function(data){
					if(data.message){
						alert("删除成功");
						$(this).parent().parent().parent().parent().remove();
						window.location.reload();
					}else{
						alert("删除失败");
					}
				}
			})
		}
		/* 获取登陆用户 */
		function getSessionUser(){
			$.ajax({
				url:"user_sessionuser",
				type:"post",
				dataType:"json",
				success:function(data){
					$(".sessionuser_uid").val(data.data.uid);
					getAlbumMess();
				}
			})			
		}
		/* 文件上传 */
		function uploadFile(){
			var formData = new FormData($( "#form_uploadAlbum")[0]);
			$.ajax({
				url:"AlbumAction_addAlbum",
				type:"POST",
				dataType: "json",
				async: false,  
				cache: false,  
				contentType: false,  
				processData: false,  
				data:formData,
				success:function(data){
					if(data.message){
						alert("上传成功");
						window.location.reload(); 
					}else{
						alert("上传失败");
					}
				}
			})
		}
	</script>

	<body style="background:  #F9F9F9;">

		<div id="head"></div>

		<div class="container" style="background: white;border-radius: 5px;">
			<div style="margin-top:20px">
				<!-- Nav tabs -->
				<ul class="nav nav-tabs" role="tablist">
					<li role="presentation" class="active">
						<a href="#home" aria-controls="home" role="tab" data-toggle="tab">
							<span class="text-primary">我的相册</span>
						</a>
					</li>
				</ul>
				<div>
					<form style="padding-left:50px" id="form_uploadAlbum" enctype="multipart/form-data">
						上传我的相册<input type="file" name="file"><br>
						<input type="hidden" name="user.uid" class="sessionuser_uid" id="sessionuser_uid">
						<input type="button" value="提交" id="uploadAlbum_sub">						
					</form>
				</div>
				<!--图片显示区域-->
				<div class="tab-content" style="margin-top: 20px;border:solid gainsboro 1px;">
					<div role="tabpanel" class="tab-pane active" id="home">
						<div class="row" id="album_container" style="padding: 50px;">
						</div>
					</div>
					<!--分页标签-->
					<div class="text-right">
						<a>显示更多...</a>
					</div>
				</div>
			</div>

		</div>
	</body>

</html>